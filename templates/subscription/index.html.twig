{% extends 'base_backofficeclient.html.twig' %}

{% block title %}S'abonner{% endblock %}

{% block body %}
    <script src="https://js.stripe.com/v3/"></script>

    <div class="row align-items-center">
        <!-- Left Section -->
        <div class="col-md-6 mb-5 mb-md-0">
            <h1 class="fw-bold">Simplifie ta gestion,<br>remplis ton agenda<br>et augmente tes r√©servations üöÄ</h1>
            <p class="fs-5 mt-3"><h2>15‚ÄØ‚Ç¨/mois ‚Äì Sans engagement</h2><br>Z√©ro commission</p>
            <ul class="list-unstyled mt-4">
                <li class="mb-2 check-green">‚úî Syst√®me de r√©servation 100‚ÄØ% personnalis√©</li>
                <li class="mb-2 check-green">‚úî Synchronisation Google Agenda</li>
                <li class="mb-2 check-green">‚úî Rappel email automatique</li>
                <li class="mb-2 check-green">‚úî Augmente ton taux de conversion</li>
                <li class="mb-2 check-green">‚úî √âvite les annulations de RDV</li>
            </ul>
            <div class="mt-4 d-flex align-items-center gap-4">
                <span>üîí Paiement s√©curis√© via Stripe</span>
                <span>üîÅ Sans engagement, annulation √† tout moment</span>
            </div>
            <div class="mt-4 d-flex align-items-center gap-4">
                {% if user.trialEndedAt is null and subscription is null %}
                    <a href="{{ path("app_subscription_trial") }}" class="btn btn-outline-primary">B√©n√©ficier de l'offre d'un mois d'essai gratuit</a>
                {% endif %}
            </div>
        </div>

        <!-- Right Section (Form) -->
        <div class="col-md-6">
            {% if subscription is null %}
                {% if user.trialEndedAt is not null %}
                    <div class="alert alert-info">
                        Vous b√©n√©ficiez de l'offre d'essai gratuit jusqu'√† l'abonnement ou le <b>{{ user.trialEndedAt|date("d-m-Y") }}</b>
                    </div>
                {% endif %}

                <div class="form-section">
                    <h3 class="mb-4">S'abonner</h3>
                    <form id="subscription-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <input type="text" class="form-control" placeholder="Pr√©nom" value="{{ user.firstname }}" disabled>
                            </div>
                            <div class="col-md-6 mb-3">
                                <input type="text" class="form-control" placeholder="Nom" value="{{ user.name }}" disabled>
                            </div>
                        </div>
                        <div class="mb-3">
                            <input type="email" class="form-control" id="email" placeholder="E-mail" value="{{ user.email }}" disabled>
                        </div>
                        <div class="mb-3">
                            <input type="text" id="promo" placeholder="Code promo" class="form-control" />
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="cguCheck">
                            <label class="form-check-label" for="cguCheck">J'accepte les <a href="/xcgu">CGU</a></label>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" placeholder="Nom sur la carte">
                        </div>
                        <div class="row mb-3" id="card-element">
                        </div>
                        <div class="mb-4">
                        <button type="submit" class="btn btn-primary w-100">Activer mon abonnement</button>
                    </form>
                </div>
            {% else %}
                {% if subscription.active == true %}
                    <h3>
                        Souscription √† 15 euros par mois active
                        <a href="{{ path("app_subscription_pause") }}" class="btn btn-outline-primary">Mettre en pause</a>
                    </h3>
                {% else %}
                    <h3>
                        Souscription √† 15 euros par mois inactive
                        <a href="{{ path("app_subscription_resume") }}" class="btn btn-outline-primary">Reprendre l'abonnement</a>
                    </h3>
                {% endif %}

                <br /><br /><br />
                <h3>Mes paiements</h3>
                <table class="table table-dark table-striped mt-3">
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>Montant</th>
                        <th>Etat</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for payment in payments %}
                        <tr>
                            <td>{{ appointment.createdAt|date("H:i d-m-Y") }}</td>
                            <td>{{ appointment.amountCents/100 }}</td>
                            <td>{{ appointment.state }}‚Ç¨</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </div>
    </div>


    <script>
    const stripe = Stripe('{{ public_key_stripe }}');
    const elements = stripe.elements();
    const style = {
      base: {
        fontSize: '16px',
        color: '#32325d',
        '::placeholder': { color: '#a0aec0' },
      }
    };

    const card = elements.create('card', { style });
    card.mount('#card-element');

    document.querySelector('#subscription-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.querySelector('#email').value;
      const promoCode = document.getElementById("promo").value;


      const { paymentMethod, error } = await stripe.createPaymentMethod({
        type: 'card',
        card: card,
        billing_details: { email }
      });

      if (error) {
        alert(error.message);
        return;
      }

      const res = await fetch('/create-subscription', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, promoCode, paymentMethod: paymentMethod.id })
      });

      const { clientSecret } = await res.json();

      const result = await stripe.confirmCardPayment(clientSecret);
      if (result.error) {
        alert(result.error.message);
      } else {
        if (result.paymentIntent.status === 'succeeded') {
          alert('Abonnement activ√© avec succ√®s !');
        }
      }
    });
    </script>
{% endblock %}
